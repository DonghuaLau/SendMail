/***********************************************************************
*发送邮件模块头文件
*可以发送文本和附件（支持多个附件一起发送）
*************************************************************************/
#pragma once
#include "StdAfx.h"
#include <winsock2.h>
//#include <afxtempl.h>
#include <vector>
using namespace std;

//typedef UINT_PTR SOCKET;

struct sMailInfo //邮件信息
{
	char*	m_pcUserName;//用户登录邮箱的名称
	char*	m_pcUserPassWord;//用户登录邮箱的密码
	char*	m_pcSenderName;//用户发送时显示的名称
	char*	m_pcSender;//发送者的邮箱地址
	char*	m_pcReceiver;//接收者的邮箱地址
	char*	m_pcTitle;//邮箱标题
	char*	m_pcBody;//邮件文本正文
	char*	m_pcIPAddr;//服务器的IP
	char*	m_pcIPName;//服务器的名称（IP与名称二选一，优先取名称）
	unsigned short m_port;//服务器的端口，默认25
	sMailInfo(){memset(this,0,sizeof(sMailInfo));}
};

struct failedInfo{
	int failedno;
	string failedemail;
};


class CSendMail
{
public:
	CSendMail(void);
	~CSendMail(void);

public:
	int SendMail(sMailInfo &smailInfo, vector<struct failedInfo> &failedList);//发送邮件，需要在发送的时候初始化邮件信息
	void AddFilePath(char * pcFilePath);//添加附件的决定路径到附件列表中
	void DeleteFilePath(char* pcFilePath);//删除附件路径，如果有的话
	void DeleteAllPath(void);//删除全部附件的路径
	int TestServer(sMailInfo &smailInfo);

protected:
	void GetFileName(char* fileName,char* filePath);//从附件的路径中获取文件名称
	void Char2Base64(char* pBuff64,char* pSrcBuff,int iLen);//把char类型转换成Base64类型
	bool  CReateSocket(SOCKET &sock);//建立socket连接
	bool  CloseSocket(SOCKET &sock);//建立socket连接
	bool Logon(SOCKET &sock);//登录邮箱，主要进行发邮件前的准备工作
	int GetFileData(char* FilePath);//由文件路径获取附件内容

	bool SendHead(SOCKET &sock);//发送邮件头
	bool SendTextBody(SOCKET &sock);//发送邮件文本正文
	int SendFileBody(SOCKET &sock);//发送邮件附件
	bool SendEnd(SOCKET &sock);//发送邮件结尾

	int SendBuf(SOCKET so, char *buf, int buf_len, int flags);
	int Sendn(SOCKET so, char *buf, int buf_len, int flags);
protected:
	vector<char*> m_pcFilePathList;//记录附件路径

	char  m_cSendBuff[4096];//发送缓冲区
	char  m_cReceiveBuff[1024];
	char* m_pcFileBuff;//指向附件内容
	sMailInfo m_sMailInfo;


};


enum SENDMAILERROR{
	NO_ERR = 0,
	CONNECT_ERR,
	LOGON_ERR,
	SEND_HEAD_ERR,
	SEND_TEXT_ERR,
	SEND_FILE_ERR,
	INVALID_FILE_NAME,
	SEND_SOCKET_ERR,
	SEND_END_ERR,
	UNDETAILED_INFO,
	CLOSE_ERR,

};